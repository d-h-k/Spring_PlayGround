## 로그 추적기 요구사항 분석
- 병목지점, 예외 터지는 부분을 분석하고 찾아내기 위한 로그추적기 시스템을 개발해야함
- 
- 
- 
- 트랜잭션 아이디도 추적(같은 요청에는 같은 ID)
d

## UUID
TraceId 를 처음 생성하면 createId() 를 사용해서 UUID를 만들어낸다. UUID가 너무 길어서 여기서는
앞 8자리만 사용한다. 이 정도면 로그를 충분히 구분할 수 있다. 여기서는 이렇게 만들어진 값을 트랜잭션ID
로 사용한다.
ab99e16f-3cde-4d24-8241-256108c203a2 //생성된 UUID
ab99e16f //앞 8자리만 사용


## UUID 란?
- 네트워크 상에서 고유성이 보장되는 id를 만들기 위한 표준 규약이다. UUID는 Universally Unique IDentifier의 약어이고 범용 고유 식별자라고 한다. 주로 분산 컴퓨팅 환경에서 사용되는 식별자
- https://docs.oracle.com/javase/1.5.0/docs/api/java/util/UUID.html
- 


## 12월 26일 스터디 정리

- 동시성 이슈 발생시키기

```text
2021-12-28 20:20:19.088  INFO 10445 --- [nio-8080-exec-1] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] |-->OrderService.orderItem()
2021-12-28 20:20:19.088  INFO 10445 --- [nio-8080-exec-1] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | |-->OrderRepository.save()
2021-12-28 20:20:20.090  INFO 10445 --- [nio-8080-exec-1] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] |<--OrderService.orderItem() time=1002ms
2021-12-28 20:20:20.091  INFO 10445 --- [nio-8080-exec-1] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] OrderControllerV3-request()! time=1006ms
2021-12-28 20:20:22.320  INFO 10445 --- [nio-8080-exec-2] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] |-->OrderControllerV3-request()!
2021-12-28 20:20:22.320  INFO 10445 --- [nio-8080-exec-2] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | |-->OrderService.orderItem()
2021-12-28 20:20:22.320  INFO 10445 --- [nio-8080-exec-2] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | |-->OrderRepository.save()
2021-12-28 20:20:23.322  INFO 10445 --- [nio-8080-exec-2] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | |<--OrderService.orderItem() time=1002ms
2021-12-28 20:20:23.322  INFO 10445 --- [nio-8080-exec-2] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] |<--OrderControllerV3-request()! time=1002ms
2021-12-28 20:20:26.552  INFO 10445 --- [nio-8080-exec-3] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | |-->OrderControllerV3-request()!
2021-12-28 20:20:26.552  INFO 10445 --- [nio-8080-exec-3] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | |-->OrderService.orderItem()
2021-12-28 20:20:26.553  INFO 10445 --- [nio-8080-exec-3] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | |-->OrderRepository.save()
2021-12-28 20:20:27.556  INFO 10445 --- [nio-8080-exec-3] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | |<--OrderService.orderItem() time=1004ms
2021-12-28 20:20:27.556  INFO 10445 --- [nio-8080-exec-3] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | |<--OrderControllerV3-request()! time=1004ms
2021-12-28 20:20:29.259  INFO 10445 --- [nio-8080-exec-6] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | |-->OrderControllerV3-request()!
2021-12-28 20:20:29.259  INFO 10445 --- [nio-8080-exec-6] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | |-->OrderService.orderItem()
2021-12-28 20:20:29.259  INFO 10445 --- [nio-8080-exec-6] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | |-->OrderRepository.save()
2021-12-28 20:20:30.261  INFO 10445 --- [nio-8080-exec-6] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | |<--OrderService.orderItem() time=1002ms
2021-12-28 20:20:30.261  INFO 10445 --- [nio-8080-exec-6] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | |<--OrderControllerV3-request()! time=1002ms
2021-12-28 20:20:44.086  INFO 10445 --- [nio-8080-exec-8] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | |-->OrderControllerV3-request()!
2021-12-28 20:20:44.086  INFO 10445 --- [nio-8080-exec-8] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | |-->OrderService.orderItem()
2021-12-28 20:20:44.086  INFO 10445 --- [nio-8080-exec-8] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | |-->OrderRepository.save()
2021-12-28 20:20:45.090  INFO 10445 --- [nio-8080-exec-8] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | |<--OrderService.orderItem() time=1004ms
2021-12-28 20:20:45.091  INFO 10445 --- [nio-8080-exec-8] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | |<--OrderControllerV3-request()! time=1005ms
2021-12-28 20:20:46.120  INFO 10445 --- [nio-8080-exec-9] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | |-->OrderControllerV3-request()!
2021-12-28 20:20:46.120  INFO 10445 --- [nio-8080-exec-9] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | |-->OrderService.orderItem()
2021-12-28 20:20:46.120  INFO 10445 --- [nio-8080-exec-9] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | |-->OrderRepository.save()
2021-12-28 20:20:47.124  INFO 10445 --- [nio-8080-exec-9] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | |<--OrderService.orderItem() time=1004ms
2021-12-28 20:20:47.125  INFO 10445 --- [nio-8080-exec-9] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | |<--OrderControllerV3-request()! time=1005ms
2021-12-28 20:20:47.219  INFO 10445 --- [io-8080-exec-10] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | |-->OrderControllerV3-request()!
2021-12-28 20:20:47.219  INFO 10445 --- [io-8080-exec-10] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | |-->OrderService.orderItem()
2021-12-28 20:20:47.219  INFO 10445 --- [io-8080-exec-10] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | |-->OrderRepository.save()
2021-12-28 20:20:48.217  INFO 10445 --- [nio-8080-exec-1] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | |-->OrderControllerV3-request()!
2021-12-28 20:20:48.217  INFO 10445 --- [nio-8080-exec-1] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | | |-->OrderService.orderItem()
2021-12-28 20:20:48.218  INFO 10445 --- [nio-8080-exec-1] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | | | |-->OrderRepository.save()
2021-12-28 20:20:48.224  INFO 10445 --- [io-8080-exec-10] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | |<--OrderService.orderItem() time=1005ms
2021-12-28 20:20:48.224  INFO 10445 --- [io-8080-exec-10] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | |<--OrderControllerV3-request()! time=1005ms
2021-12-28 20:20:49.096  INFO 10445 --- [nio-8080-exec-2] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | | |-->OrderControllerV3-request()!
2021-12-28 20:20:49.097  INFO 10445 --- [nio-8080-exec-2] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | | | |-->OrderService.orderItem()
2021-12-28 20:20:49.097  INFO 10445 --- [nio-8080-exec-2] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | | | | |-->OrderRepository.save()
2021-12-28 20:20:49.222  INFO 10445 --- [nio-8080-exec-1] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | | |<--OrderService.orderItem() time=1005ms
2021-12-28 20:20:49.223  INFO 10445 --- [nio-8080-exec-1] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | |<--OrderControllerV3-request()! time=1006ms
2021-12-28 20:20:49.943  INFO 10445 --- [nio-8080-exec-4] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | | | |-->OrderControllerV3-request()!
2021-12-28 20:20:49.943  INFO 10445 --- [nio-8080-exec-4] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | | | | |-->OrderService.orderItem()
2021-12-28 20:20:49.943  INFO 10445 --- [nio-8080-exec-4] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | | | | | |-->OrderRepository.save()
2021-12-28 20:20:50.100  INFO 10445 --- [nio-8080-exec-2] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | | | |<--OrderService.orderItem() time=1003ms
2021-12-28 20:20:50.100  INFO 10445 --- [nio-8080-exec-2] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | | |<--OrderControllerV3-request()! time=1004ms
2021-12-28 20:20:50.947  INFO 10445 --- [nio-8080-exec-4] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | | | | |<--OrderService.orderItem() time=1004ms
2021-12-28 20:20:50.947  INFO 10445 --- [nio-8080-exec-4] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | | | |<--OrderControllerV3-request()! time=1004ms
2021-12-28 20:20:51.238  INFO 10445 --- [nio-8080-exec-5] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | | |-->OrderControllerV3-request()!
2021-12-28 20:20:51.238  INFO 10445 --- [nio-8080-exec-5] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | | | |-->OrderService.orderItem()
2021-12-28 20:20:51.238  INFO 10445 --- [nio-8080-exec-5] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | | | | |-->OrderRepository.save()
2021-12-28 20:20:52.240  INFO 10445 --- [nio-8080-exec-5] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | | | |<--OrderService.orderItem() time=1002ms
2021-12-28 20:20:52.241  INFO 10445 --- [nio-8080-exec-5] h.advenced.trace.logtrace.FieldLogTrace  : [b70cfbcd] | | | | | | | | | |<--OrderControllerV3-request()! time=1003ms


```
- 동시성 문제 발생하는거 확인
  - 왜 발생하냐면 FieldLogTrace 는 싱글톤으로 등록된 스프링 빈이다. 이 객체의 인스턴스가 애플리케이션에 딱 하나만존재한다는 뜻이다. 이렇게 하나만 있는 인스턴스의 FieldLogTrace.traceIdHolder 필드를 여러
  쓰레드가 동시에 접근하기 때문에 문제가 발생한다.
  실무에서 한번 나타나면 개발자를 가장 괴롭히는 문제도 바로 이러한 동시성 문제이다


## AOP 미리보기
- 따라갈수 없다면 앞질러가겠어..
- 여러 클래스에 나뉘어있는 책임을 Aspect: 관점이라고 부르는데
- 이 Aspect 를 별도의 클래스에 몰아넣는(캡슐화) 하는 접근 방식을 AOP 라고 합니다
- 여러 클래스에 나뉘어있는 책임을 Aspect라고 했는데, 또다른 용어로 횡단 관심사(cross-cutting concern) 이라고도 하는데
  - 대표적으로 로깅, 트랜잭션 관리, 캐싱, 보안(인증인가 세션처리 등등)
- 용어가 이거같은데(의견 감사합니당)
  - 기술 장르 : ORM > AOP
  - 스프링에서 : JPA > Spring-AOP
  - 내부구현체 : 하이버네이트 > eclipse-aspectJ

### AOP 주요용어
- Advice : 횡단관심사를 구현하는 애스팩트의 메서드
- 포인트컷 : 각각의 어드바이스들이 그 어드바이스를 적용할 메서드를 구별하는 기준
- 조인 포인트 : 어드바이스를 적용할 메서드
- 스프링 AOP 프레임워크는 프록시 기반
  - 프록시 : JPA 에서도 나옴(아래 설명)
  - 어드바이스 대상 객체마다 프록시가 만들어진다

### 예시
```java
@ControllerAdvice // 1 - AOP 라는거
@Slf4j
public class ExceptionControllerAdvice {//관례적으로 Advice 라고 붙여줌 

    @ExceptionHandler({OutOfDateException.class}) // 포인트컷, 이 예외 발생시 사용
    public ResponseEntity<?> handleAccessDeniedException(final OutOfDateException e) {
        log.warn("OutOfDateException {}", e.getMessage()); //이 메서드는 조인포인트
        return ResponseEntity.status(HttpStatus.METHOD_NOT_ALLOWED).body(e.getMessage());
    }
    
}
```


### 프록시..
- 어디서씀?
  - AOP : 도 프록시를 쓴다고 하고
  - JPA : 에서 연관 객체들 처음부터 데이터베이스에서 조회하는 것이 아니라, 실제 사용하는 시점에 조회하는지 아닌지 설정하는게 즉시로딩 ( EAGER ) 과 지연로딩 ( LAZY ) 인데 이와 관련 된 기술이 프록시 인데, 이 프록시를 통해서
  - 트랜잭션(디비)

- 왜씀? Proxy를 사용하는 이유
  - OCP(Open - Closed Principle)을 지키기 위해서 사용합니다
  - 개방 폐쇄 원칙 확장에 대해서는 열려있어야 하고, 수정에 대해서는 닫혀있다
  - (좀더 친절하게) 기획자가 요구를 바꾸더라도 기존 구성요소는 수정이 일어나면 안됨
  - 기존 구성요소를 확장해서 기능을 추가하고 확장하는게 쉬워야 한다
  - 변하는것과 변화하지 않는것을 분리(변경주기가 같은것과 다른것을 뜯어내고) >> 이 분리한 생명주기 다른것 끼리 인터페이스-클래스로 연결해주고
  - 구체화(클래스) 에 의존하기보다 추상화
  - https://huisam.tistory.com/entry/springAOP
  
